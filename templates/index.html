<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico de Tendinopat√≠a</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>ü©ª Diagn√≥stico de Tendinopat√≠a</h1>

        <form id="upload-form" onsubmit="event.preventDefault(); sendImage();">
            <div class="upload-area" id="upload-area">
                <p>Arrastra una radiograf√≠a (.jpg, .png, .dcm) o haz clic para seleccionar</p>
                <input type="file" id="fileInput" name="file" accept=".dcm,image/*" style="display:none;">
                <p id="file-name" class="file-name"></p>
            </div>

            <label for="sex">Sexo:</label>
            <select id="sex" name="sex" required>
                <option value="">Selecciona</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
            </select>

            <label for="birthdate">Fecha de nacimiento:</label>
            <input type="date" id="birthdate" name="birthdate" required>

            <div id="preview-container">
                <img id="preview" src="#" alt="Vista previa" style="display: none;" />
            </div>

            <button type="submit" id="predict-btn">Predecir</button>
        </form>

        <div id="status"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const status = document.getElementById('status');
        const fileName = document.getElementById('file-name');
        const uploadArea = document.getElementById('upload-area');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            showPreview(file);
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) showPreview(file);
        });

        function showPreview(file) {
            const isImage = file.type.startsWith('image/');
            const isDcm = file.name.toLowerCase().endsWith('.dcm');

            if (!isImage && !isDcm) {
                status.innerHTML = "<span class='error'>‚ö†Ô∏è El archivo debe ser una imagen o un DICOM (.dcm).</span>";
                return;
            }

            if (isImage) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            status.innerHTML = "";
            fileName.textContent = `üìÅ ${file.name}`;
        }

        async function sendImage() {
            const file = fileInput.files[0];
            const sex = document.getElementById('sex').value;
            const birthdate = document.getElementById('birthdate').value;

            if (!file || !sex || !birthdate) {
                status.innerHTML = "<span class='error'>‚ö†Ô∏è Rellena todos los campos y selecciona un archivo.</span>";
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("sex", sex);
            formData.append("birthdate", birthdate);

            status.innerHTML = "<span class='loading'>üîÑ Procesando...</span>";

            try {
                const response = await fetch("/predict/", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    const label = result.prediction === 1 ? "Tendinopat√≠a Detectada" : "Sin Tendinopat√≠a";
                    const icon = result.prediction === 1 ? "üü•" : "üü©";
                    status.innerHTML = `<span class='result'>${icon} <strong>${label}</strong></span>`;
                } else {
                    status.innerHTML = `<span class='error'>‚ùå Error: ${result.error}</span>`;
                }
            } catch (e) {
                status.innerHTML = `<span class='error'>‚ùå Error inesperado</span>`;
            }
        }
    </script>
</body>
</html>